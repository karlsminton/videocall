<!DOCTYPE html>
<html>
    <head>
        <title>Socket Test</title>
    </head>
    <body>
        <h1>Socket Test</h1>
        <main></main>
        <button>Start Call</button>
        <script>

            const constraints = {
                video: true,
                audio: true
            }

            let button = document.querySelector('button')
            let main = document.querySelector('main')

            const websocket = new WebSocket('ws://127.0.0.1:3000')

            button.addEventListener('click', (e) => {
                if (
                    navigator 
                    && navigator.mediaDevices
                ) {
                    navigator.mediaDevices.getUserMedia(constraints)
                        .then((stream) => {
                            window.stream = stream
                            video = document.createElement('video')
                            video.srcObject = stream
                            video.onloadedmetadata = (e) => {
                                video.play()
                                document.querySelector('main').appendChild(video)
                            }
                            
                            websocket.send(
                                JSON.stringify(
                                    {
                                        message: 'stream', 
                                        stream: stream
                                    }
                                )
                            )
                        })
                }
            })
            
            websocket.onopen = (e) => {}

            websocket.onclose = (e) => {
                console.log('connection closed')
            }

            websocket.onerror = (e) => {
                console.log(`socket error - ${e.message}`)
            }

            websocket.onmessage = (e) => {
                console.log(e.data.stream)
                let data = e.data
                if (data.stream) {
                    console.log('is stream')
                    window.stream = data.stream
                    video = document.createElement('video')
                    video.srcObject = data.stream
                    video.onloadedmetadata = (e) => {
                        video.play()
                        document.querySelector('main').appendChild(video)
                    }
                }
                // write(`server response - ${e.data}`)
            }
        </script>
    </body>
</html>